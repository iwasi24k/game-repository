name: AI PR Review

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: >
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip ai]')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OPENAI_MODEL: gpt-5-mini
      MAX_DIFF_SIZE: 200000  # バイト単位

    steps:
      - uses: actions/checkout@v4

      - name: Prepare diff
        run: |
          git fetch origin develop
          git diff origin/develop > diff.txt

          if [ ! -s diff.txt ]; then
            echo "No diff found. Skip AI review."
            exit 0
          fi

          if [ $(wc -c < diff.txt) -gt $MAX_DIFF_SIZE ]; then
            head -c $MAX_DIFF_SIZE diff.txt > diff_trunc.txt
            DIFF_FILE=diff_trunc.txt
          else
            DIFF_FILE=diff.txt
          fi

          echo "Using diff file: $DIFF_FILE"
          echo "DIFF_FILE=$DIFF_FILE" >> $GITHUB_ENV

      - name: Create payload
        run: |
          SYSTEM_PROMPT="あなたはシニアソフトウェアエンジニアです。以下のプルリクエストの差分コードをレビューし、問題点・改善点・潜在的なバグを簡潔に指摘してください。"
          jq -n --arg model "$OPENAI_MODEL" \
                --arg system "$SYSTEM_PROMPT" \
                --arg user "$(cat $DIFF_FILE)" \
                '{model:$model,messages:[{role:"system",content:$system},{role:"user",content:$user}]}' > payload.json

      - name: Call OpenAI API
        run: |
          HTTP_STATUS=$(curl -sS --retry 3 --retry-delay 2 --max-time 60 \
            -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -o response.json \
            -w "%{http_code}" \
            -d @payload.json)

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "OpenAI API request failed with status $HTTP_STATUS"
            head -n 50 response.json
            exit 1
          fi

      - name: Extract review
        run: |
          REVIEW=$(jq -r '.choices[0].message.content' response.json)
          if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
            echo "No valid review returned from API."
            exit 1
          fi
          echo "$REVIEW" > review.txt

      - name: Comment PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file review.txt
