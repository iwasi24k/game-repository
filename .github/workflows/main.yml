name: AI PR Review

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: >
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip ai]')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}

    steps:
      - uses: actions/checkout@v4

      - name: Get diff
        run: |
          git fetch origin develop
          git diff origin/develop > diff.txt

      - name: Comment PR with AI Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -s diff.txt ]; then
            echo "No diff found. Skip AI review."
            exit 0
          fi

          DIFF_ESCAPED=$(jq -Rs '.' < diff.txt)

          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4.1-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å·®åˆ†ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€å•é¡Œç‚¹ãƒ»æ”¹å–„ç‚¹ãƒ»æ½œåœ¨çš„ãªãƒã‚°ã‚’ç°¡æ½”ã‹ã¤å»ºè¨­çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚\"},
                {\"role\": \"user\", \"content\": $DIFF_ESCAPED}
              ]
            }")

          STATUS=$(tail -n1 <<< "$RESPONSE")
          if [ "$STATUS" -ne 200 ]; then
            echo "OpenAI API request failed with status $STATUS"
            exit 1
          fi

          REVIEW=$(jq -r '.choices[0].message.content' response.json)

          gh pr comment $PR_NUMBER \
            --body "### ðŸ¤– AI Code Review\n\n$REVIEW"
