name: AI PR Review

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    if: >
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip ai]')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}

    steps:
      - uses: actions/checkout@v4

      - name: Get diff
        run: |
          git fetch origin develop
          git diff origin/develop > diff.txt

      - name: Comment PR with AI Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # diff „ÅåÁ©∫„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó
          if [ ! -s diff.txt ]; then
            echo "No diff found. Skip AI review."
            exit 0
          fi

          # diff „Çí JSON „Ç®„Çπ„Ç±„Éº„Éó
          DIFF_ESCAPED=$(jq -Rs '.' < diff.txt)

          # OpenAI API „Å´ÈÄÅ‰ø°„Åó„Å¶ÁµêÊûú„Çí response.json „Å´‰øùÂ≠ò
          HTTP_STATUS=$(curl -s -o response.json -w "%{http_code}" -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-5-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"„ÅÇ„Å™„Åü„ÅØ„Ç∑„Éã„Ç¢„ÇΩ„Éï„Éà„Ç¶„Çß„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Éó„É´„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÂ∑ÆÂàÜ„Ç≥„Éº„Éâ„Çí„É¨„Éì„É•„Éº„Åó„ÄÅÂïèÈ°åÁÇπ„ÉªÊîπÂñÑÁÇπ„ÉªÊΩúÂú®ÁöÑ„Å™„Éê„Ç∞„ÇíÁ∞°ÊΩî„Åã„Å§Âª∫Ë®≠ÁöÑ„Å´ÊåáÊëò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\"},
                {\"role\": \"user\", \"content\": $DIFF_ESCAPED}
              ]
            }")

          # HTTP „Çπ„ÉÜ„Éº„Çø„Çπ„Åå 200 ‰ª•Â§ñ„Å™„Çâ„Ç®„É©„Éº
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "OpenAI API request failed with status $HTTP_STATUS"
            cat response.json
            exit 1
          fi

          # „É¨„Éì„É•„ÉºÁµêÊûú„ÇíÂèñÂæó
          REVIEW=$(jq -r '.choices[0].message.content' response.json)

          # PR „Å´„Ç≥„É°„É≥„Éà
          gh pr comment $PR_NUMBER \
            --body "### ü§ñ AI Code Review\n\n$REVIEW"
