//==============================================================================
// File        : InputMouse.h
//------------------------------------------------------------------------------
// Author      : ix.U
// Created     : 2025-08-20
// Last Update : 2025-08-29
//------------------------------------------------------------------------------
// 
//==============================================================================
#ifndef INPUT_MOUSE_H
#define INPUT_MOUSE_H

#include <Windows.h>
#include "MathTransform.h"

namespace Framework {

    class InputMouse {
    private:
        HWND m_hWnd = nullptr;

        bool m_MouseButton[3] = {};
        bool m_MousePrevButton[3] = {};
        bool m_MouseDownTemp[3] = {};

        POINT m_MousePos = {};

        int m_WheelDelta = 0;
        int s_WheelDeltaCached = 0;

        bool s_CursorLockEnabled = false;

        math::vector2f s_MouseRelativeMovement{ 0.0f, 0.0f };
        math::vector2f s_LastMousePos{ 0.0f, 0.0f };
        bool s_FirstUpdate = true;

		InputMouse() = default;
		~InputMouse() = default;
		InputMouse(const InputMouse&) = delete;
		InputMouse& operator=(const InputMouse&) = delete;

    public:
        static InputMouse& GetInstance() {
            static InputMouse instance;
            return instance;
        }

        // ◆ マウスボタン
        // MB::Left => 左クリック / MB::Right => 右クリック / MB::Middle => ホイールクリック
        enum class MouseButton { Left = 0, Right = 1, Middle = 2 };

        //==============================================================================
        // 
        // ◆ マウスボタンの状態取得：ボタンが現在「押されている」かどうか
        // 例：ドラッグ処理や押しっぱなし判定に使用
        // 
        // 引数：
        // - button：MB::Left / MB::Right / MB::Middle
        // 
        // 戻り値：
        // - true ：ボタンが押されている
        // - false：ボタンが押されていない
        //
        //==============================================================================
        bool IsMouseDown(MouseButton button);

        //==============================================================================
        // 
        // ◆ マウスボタンの「クリック（単押し）」判定：
        // 前フレームで押されておらず、今フレームで押された場合に true を返す
        // 
        // 引数：
        // - button：MB::Left / MB::Right / MB::Middle
        // 
        // 戻り値：
        // - true ：前フレームでは押されておらず、今フレームで押された
        // - false：前フレームでも押されていた、または今フレームで押されていない
        // 
        // 例：UI選択・決定ボタン等に使用
        //
        //==============================================================================
        bool IsMouseClicked(MouseButton button);

        //==============================================================================
        // 
        // ◆ マウスボタンが「今フレームで離された」かを判定（リリース検出）
        // 
        // 引数：
        // - button：MB::Left / MB::Right / MB::Middle
        // 
        // 戻り値：
        // - true ：前フレームでは押されており、今フレームで離された
        // - false：前フレームでも押されていなかった、または今フレームで押されている
        // 
        // 用途例：ドラッグ解除、UI確定後の指離し判定、チャージ解除など
        //
        //==============================================================================
        bool IsMouseReleased(MouseButton button);

        //==============================================================================
        // 
        // ◆ マウスカーソルの現在座標を取得（クライアント座標系）
        // 
        // 戻り値：
        // - Vector2 : 画面左上が (0,0) の座標空間におけるマウスカーソルの位置
        // 
        // 例：UIや当たり判定の中心として使用可能
        //
        //==============================================================================
        math::vector2f GetMousePosition();

        //==============================================================================
        // 
        // ◆ マウスホイールの回転量を取得（整数値）
        // 上方向に回すと +1、下方向に回すと -1、回していない場合は 0 を返す
        // フレーム毎にリセットされる「単発型入力」
        // 例：ズーム処理・ページ切替などに使用
        //
        //==============================================================================
        int GetWheelDelta();

        //==============================================================================
        // 
        // ◆ マウスカーソルと矩形のヒット判定（回転付き）
        // 
        // 引数：
        // - center：矩形の中心座標（ワールドまたはスクリーン）
        // - size：矩形の幅・高さ
        // - rotationRad：矩形の回転角（ラジアン、時計回り）※省略時は 0（無回転）
        // 
        // 戻り値：
        // - true  : マウスが矩形範囲内にある
        // - false : マウスが矩形範囲外にある
        // 
        // 例：ボタンやメニュー項目の選択判定に使用
        //
        //==============================================================================
        bool HitBox(const math::vector2f& center, const math::vector2f& size, float rotationRad = 0.0f);

        //==============================================================================
        // 
        // ◆ マウスカーソルの表示・非表示を切り替える
        // 
        // 引数：
        // - true  : 表示 
        // - false : 非表示
        // 
        // 例：FPS / TPS カメラモード中は非表示、UI操作時は表示など、状態に応じて切り替え
        //
        //==============================================================================
        void DisplayMouse(bool display);

        //==============================================================================
        // 
        // ◆ カーソルを画面中央に固定するかどうかを制御
        // 
        // 引数：
        // - true  : 毎フレーム中央にロック
        // - false : ロック解除
        // 
        // 例：マウス操作で視点回転する場合に有効。ロック中はGetMouseRelativeMovement()を用いて視点回転を行う設計が推奨される
        //
        //==============================================================================
        void EnableCursorLock(bool enable);

        //==============================================================================
        // 
        // ◆ マウスカーソルをクライアント領域の中央に移動させる
        // - カメラ操作中などでカーソル位置を初期化したい場合に使用
        //
        //==============================================================================
        void LockCursorCenter();

        //==============================================================================
        // 
        // ◆ マウスカーソルの相対移動量（前フレームとの差分）を取得
        // 
        // 戻り値：
        // - Vector2 :（x = 横方向移動量, y = 縦方向移動量）
        // 
        // 注意：マウス座標を毎フレーム自動的に追跡し、内部的に保存された前回位置との差を返す
        // 用途例：TPS/FPS視点におけるカメラ回転、ドラッグ操作、ポインタの慣性移動など
        // 
        //==============================================================================
        math::vector2f GetMouseRelativeMovement();

    private:
        void ResetLastMousePosition(const math::vector2f& pos);

        // Application1箇所で呼び出し
        void Initialize(HWND hwnd);
        void Update();

        // WndProc連携
        void OnMouseDown(int button);
        void OnMouseUp(int button);
        void OnWheel(short delta);

        friend class Application;
        friend class Window;
    };

    using MB = InputMouse::MouseButton;
}

#endif // INPUT_MOUSE_H